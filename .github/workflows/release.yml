name: Release

on:
    push:
        tags:
            - "v*.*.*"

permissions:
    contents: write

jobs:
    release:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Set up Go
              uses: actions/setup-go@v5
              with:
                  go-version: "1.21"

            - name: Run tests
              run: make test

            - name: Build binaries
              run: |
                  # Extract version from tag
                  VERSION=${GITHUB_REF#refs/tags/}

                  # Build for multiple platforms
                  GOOS=linux GOARCH=amd64 go build \
                    -ldflags "-X github.com/AD7six/dd-tf/internal/commands/version.Version=${VERSION} \
                              -X github.com/AD7six/dd-tf/internal/commands/version.Commit=${GITHUB_SHA::7} \
                              -X github.com/AD7six/dd-tf/internal/commands/version.BuildDate=$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
                    -o bin/dd-tf-linux-amd64 ./cmd/dd-tf/main.go

                  GOOS=linux GOARCH=arm64 go build \
                    -ldflags "-X github.com/AD7six/dd-tf/internal/commands/version.Version=${VERSION} \
                              -X github.com/AD7six/dd-tf/internal/commands/version.Commit=${GITHUB_SHA::7} \
                              -X github.com/AD7six/dd-tf/internal/commands/version.BuildDate=$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
                    -o bin/dd-tf-linux-arm64 ./cmd/dd-tf/main.go

                  GOOS=darwin GOARCH=amd64 go build \
                    -ldflags "-X github.com/AD7six/dd-tf/internal/commands/version.Version=${VERSION} \
                              -X github.com/AD7six/dd-tf/internal/commands/version.Commit=${GITHUB_SHA::7} \
                              -X github.com/AD7six/dd-tf/internal/commands/version.BuildDate=$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
                    -o bin/dd-tf-darwin-amd64 ./cmd/dd-tf/main.go

                  GOOS=darwin GOARCH=arm64 go build \
                    -ldflags "-X github.com/AD7six/dd-tf/internal/commands/version.Version=${VERSION} \
                              -X github.com/AD7six/dd-tf/internal/commands/version.Commit=${GITHUB_SHA::7} \
                              -X github.com/AD7six/dd-tf/internal/commands/version.BuildDate=$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
                    -o bin/dd-tf-darwin-arm64 ./cmd/dd-tf/main.go

                  GOOS=windows GOARCH=amd64 go build \
                    -ldflags "-X github.com/AD7six/dd-tf/internal/commands/version.Version=${VERSION} \
                              -X github.com/AD7six/dd-tf/internal/commands/version.Commit=${GITHUB_SHA::7} \
                              -X github.com/AD7six/dd-tf/internal/commands/version.BuildDate=$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
                    -o bin/dd-tf-windows-amd64.exe ./cmd/dd-tf/main.go

            - name: Generate checksums
              run: |
                  cd bin
                  sha256sum dd-tf-* > checksums.txt
                  cat checksums.txt

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v1
              with:
                  files: |
                      bin/dd-tf-linux-amd64
                      bin/dd-tf-linux-arm64
                      bin/dd-tf-darwin-amd64
                      bin/dd-tf-darwin-arm64
                      bin/dd-tf-windows-amd64.exe
                      bin/checksums.txt
                  generate_release_notes: true
                  draft: false
                  prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
