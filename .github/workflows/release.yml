name: Release

on:
    push:
        tags:
            - "v*.*.*"

permissions:
    contents: write

jobs:
    release:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Set up Go
              uses: actions/setup-go@v5
              with:
                  go-version: "1.21"

            - name: Run tests
              run: make test

            - name: Build binaries
              run: |
                  # Extract version from tag
                  VERSION=${GITHUB_REF#refs/tags/}

                  # Build for multiple platforms
                  GOOS=linux GOARCH=amd64 go build \
                    -ldflags "-X github.com/AD7six/dd-tf/internal/commands/version.Version=${VERSION} \
                              -X github.com/AD7six/dd-tf/internal/commands/version.Commit=${GITHUB_SHA::7} \
                              -X github.com/AD7six/dd-tf/internal/commands/version.BuildDate=$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
                    -o bin/dd-tf-linux-amd64 ./cmd/dd-tf/main.go

                  GOOS=linux GOARCH=arm64 go build \
                    -ldflags "-X github.com/AD7six/dd-tf/internal/commands/version.Version=${VERSION} \
                              -X github.com/AD7six/dd-tf/internal/commands/version.Commit=${GITHUB_SHA::7} \
                              -X github.com/AD7six/dd-tf/internal/commands/version.BuildDate=$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
                    -o bin/dd-tf-linux-arm64 ./cmd/dd-tf/main.go

                  GOOS=darwin GOARCH=amd64 go build \
                    -ldflags "-X github.com/AD7six/dd-tf/internal/commands/version.Version=${VERSION} \
                              -X github.com/AD7six/dd-tf/internal/commands/version.Commit=${GITHUB_SHA::7} \
                              -X github.com/AD7six/dd-tf/internal/commands/version.BuildDate=$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
                    -o bin/dd-tf-darwin-amd64 ./cmd/dd-tf/main.go

                  GOOS=darwin GOARCH=arm64 go build \
                    -ldflags "-X github.com/AD7six/dd-tf/internal/commands/version.Version=${VERSION} \
                              -X github.com/AD7six/dd-tf/internal/commands/version.Commit=${GITHUB_SHA::7} \
                              -X github.com/AD7six/dd-tf/internal/commands/version.BuildDate=$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
                    -o bin/dd-tf-darwin-arm64 ./cmd/dd-tf/main.go

                  GOOS=windows GOARCH=amd64 go build \
                    -ldflags "-X github.com/AD7six/dd-tf/internal/commands/version.Version=${VERSION} \
                              -X github.com/AD7six/dd-tf/internal/commands/version.Commit=${GITHUB_SHA::7} \
                              -X github.com/AD7six/dd-tf/internal/commands/version.BuildDate=$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
                    -o bin/dd-tf-windows-amd64.exe ./cmd/dd-tf/main.go

            - name: Generate checksums
              run: |
                  cd bin
                  sha256sum dd-tf-* > checksums.txt
                  cat checksums.txt

            - name: Create GitHub Release (draft) and upload assets
              uses: softprops/action-gh-release@v1
              with:
                  files: |
                      bin/dd-tf-linux-amd64
                      bin/dd-tf-linux-arm64
                      bin/dd-tf-darwin-amd64
                      bin/dd-tf-darwin-arm64
                      bin/dd-tf-windows-amd64.exe
                      bin/checksums.txt
                  generate_release_notes: true
                  draft: true
                  prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}

            - name: Publish GitHub Release
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  TAG=${GITHUB_REF#refs/tags/}
                  REPLY=$(curl -s -H "Authorization: token ${GITHUB_TOKEN}" "https://api.github.com/repos/${GITHUB_REPOSITORY}/releases/tags/${TAG}")
                  RELEASE_ID=$(python - <<'PY'
                  import sys, json
                  obj = json.load(sys.stdin)
                  print(obj.get("id", ""))
                  PY
                  <<<"$REPLY")
                  if [ -z "$RELEASE_ID" ]; then
                    echo "Release for tag ${TAG} not found; aborting publish."
                    echo "$REPLY" | sed -n '1,200p'
                    exit 1
                  fi
                  echo "Publishing release id: $RELEASE_ID"
                  curl -s -X PATCH -H "Authorization: token ${GITHUB_TOKEN}" -H "Content-Type: application/json" -d '{"draft":false}' "https://api.github.com/repos/${GITHUB_REPOSITORY}/releases/${RELEASE_ID}" | sed -n '1,200p'
